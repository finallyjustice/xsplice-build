SHELL = /bin/sh
CC    = gcc

.PHONY: all install clean distclean
.DEFAULT: all

CFLAGS  += -Iinsn -Wall -g
LDFLAGS = -lcrypto

CERTS = signing_key.pem signing_key.x509
TARGETS = sign-file extract-cert $(CERTS)
SIGN_OBJS = sign-file.o
EXTRACT_CERT_OBJS = extract-cert.o
SOURCES = sign-file.c extract-cert.c

all: $(TARGETS)

-include $(SOURCES:.c=.d)

%.o : %.c
	$(CC) -MMD -MP $(CFLAGS) -c -o $@ $<

sign-file: $(SIGN_OBJS)
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

extract-cert: $(EXTRACT_CERT_OBJS)
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

clean:
	$(RM) $(TARGETS) $(SIGN_OBJS) $(EXTRACT_CERT_OBJS) *.d insn/*.d

distclean: clean
	$(RM) $(CERTS)

# Generate a certificate if needed
# These routines come from Linux.
signing_key.pem: x509.genkey
	@echo "###"
	@echo "### Now generating an X.509 key pair to be used for signing modules."
	@echo "###"
	@echo "### If this takes a long time, you might wish to run rngd in the"
	@echo "### background to keep the supply of entropy topped up.  It"
	@echo "### needs to be run as root, and uses a hardware random"
	@echo "### number generator if one is available."
	@echo "###"
	openssl req -new -nodes -utf8 -sha256 -days 36500 \
	        -batch -x509 -config x509.genkey \
	        -outform PEM -out signing_key.pem \
	        -keyout signing_key.pem 2>&1
	@echo "###"
	@echo "### Key pair generated."
	@echo "###"

x509.genkey:
	@echo Generating X.509 key generation config
	@echo  >$@ "[ req ]"
	@echo >>$@ "default_bits = 4096"
	@echo >>$@ "distinguished_name = req_distinguished_name"
	@echo >>$@ "prompt = no"
	@echo >>$@ "string_mask = utf8only"
	@echo >>$@ "x509_extensions = myexts"
	@echo >>$@
	@echo >>$@ "[ req_distinguished_name ]"
	@echo >>$@ "#O = Unspecified company"
	@echo >>$@ "CN = Build time autogenerated kernel key"
	@echo >>$@ "#emailAddress = unspecified.user@unspecified.company"
	@echo >>$@
	@echo >>$@ "[ myexts ]"
	@echo >>$@ "basicConstraints=critical,CA:FALSE"
	@echo >>$@ "keyUsage=digitalSignature"
	@echo >>$@ "subjectKeyIdentifier=hash"
	@echo >>$@ "authorityKeyIdentifier=keyid"
.INTERMEDIATE: x509.genkey

signing_key.x509: extract-cert signing_key.pem
	./extract-cert signing_key.pem $@
